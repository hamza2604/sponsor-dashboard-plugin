<?php
// Prevent direct access
if (!defined('ABSPATH')) {
exit;
}
// Add admin menu
add_action('admin_menu', 'sdp_admin_menu');
function sdp_admin_menu() {
add_menu_page('Sponsor Orders', 'Sponsor Orders', 'manage_options', 'sdp-orders', 'sdp_render_orders_page', 'dashicons-list-view');
add_submenu_page('sdp-orders', 'Manage Services', 'Manage Services', 'manage_options', 'edit.php?post_type=sponsor_services');
}
// Render orders page
function sdp_render_orders_page() {
global $wpdb;
$orders = $wpdb->get_results("SELECT * FROM {$wpdb->prefix}sponsor_orders");
?>
<div class="wrap">
<h1>Sponsor Orders</h1>
<table class="wp-list-table widefat striped">
<thead>
<tr>
<th>ID</th>
<th>Sponsor</th>
<th>Service</th>
<th>Quantity</th>
<th>Total</th>
<th>Status</th>
<th>Screenshot</th>
<th>Note</th>
<th>Link</th>
<th>Action</th>
</tr>
</thead>
<tbody>
<?php foreach ($orders as $order) {
$user = get_userdata($order->user_id);
$service = get_post($order->service_id);
?>
<tr>
<td><?php echo $order->order_id; ?></td>
<td><?php echo esc_html($user->display_name); ?></td>
<td><?php echo esc_html($service->post_title); ?></td>
<td><?php echo $order->quantity; ?></td>
<td>$<?php echo $order->total; ?></td>
<td><?php echo esc_html($order->status); ?></td>
<td><a href="<?php echo esc_url($order->screenshot_url); ?>" target="_blank">View</a></td>
<td><?php echo esc_html($order->note); ?></td>
<td><a href="<?php echo esc_url($order->link); ?>" target="_blank"><?php echo esc_html($order->link); ?></a></td>
<td>
<a href="<?php echo admin_url('admin.php?page=sdp-orders&action=approve&order_id=' . $order->order_id); ?>" class="button">Approve</a>
<a href="<?php echo admin_url('admin.php?page=sdp-orders&action=reject&order_id=' . $order->order_id); ?>" class="button">Reject</a>
</td>
</tr>
<?php
} ?>
</tbody>
</table>
</div>
<?php
}
// Handle approve/reject actions
add_action('admin_init', 'sdp_handle_order_actions');
function sdp_handle_order_actions() {
if (isset($_GET['page']) && $_GET['page'] === 'sdp-orders' && isset($_GET['action']) && isset($_GET['order_id'])) {
global $wpdb;
$order_id = intval($_GET['order_id']);
$action = sanitize_text_field($_GET['action']);
$status = ($action === 'approve') ? 'Approved' : 'Rejected';
$wpdb->update(
$wpdb->prefix . 'sponsor_orders',
['status' => $status],
['order_id' => $order_id]
);
wp_redirect(admin_url('admin.php?page=sdp-orders'));
exit;
}
}
// Add meta boxes for services
add_action('add_meta_boxes', 'sdp_service_meta_boxes');
function sdp_service_meta_boxes() {
add_meta_box('sdp_service_details', 'Service Details', 'sdp_service_details_callback', 'sponsor_services');
}
function sdp_service_details_callback($post) {
wp_nonce_field('sdp_service_details', 'sdp_service_nonce');
$rate = get_post_meta($post->ID, 'service_rate', true);
$category = get_post_meta($post->ID, 'service_category', true);
?>
<p><label>Rate: <input type="number" step="0.01" name="service_rate" value="<?php echo esc_attr($rate); ?>"></label></p>
<p><label>Category:
<select name="service_category">
<option value="Main" <?php selected($category, 'Main'); ?>>Main</option>
<option value="Other" <?php selected($category, 'Other'); ?>>Other</option>
</select>
</label></p>
<?php
}
add_action('save_post', 'sdp_save_service_details');
function sdp_save_service_details($post_id) {
if (!isset($_POST['sdp_service_nonce']) || !wp_verify_nonce($_POST['sdp_service_nonce'], 'sdp_service_details')) return;
if (isset($_POST['service_rate'])) update_post_meta($post_id, 'service_rate', floatval($_POST['service_rate']));
if (isset($_POST['service_category'])) update_post_meta($post_id, 'service_category', sanitize_text_field($_POST['service_category']));
}